'use strict';import{syslog}from'./syslog.js';import{localert}from'./locmodals.js';import{store as lstore}from'./localStorage.js';import{aton,ntoa,Prefix}from'./ntools.js';const fib=document.querySelector('section#content div ul');fib||syslog.panic(Error('Ausgabeliste fehlt!'));const dom2route=new WeakMap,localORbroadcast=`
  <p class="msg">Die zugewiesene IP-Adresse ist nicht sinnvoll!</p>
  <p class="desc">
    Die unterste Adresse eines Adressbereiches ist reserviert für
    den lokalen Rechner (local host), die oberste für die Broadcast Adresse (broadcast).
    Beide Adressen dürfen deshalb Schnittstellen nicht zugeordnet werden.
  </p>
`,networkIsUnreachable=`
  <p class="msg">Network is unreachable</p>
  <p class="expl">Netzwerk ist nicht erreichbar</p>
  <p class="desc">Es gibt keinen passenden FIB-Eintrag für die Zieladresse</p>
`,noSuchProcess=`
  <p class="msg">No such process</p>
  <p class="expl">Kein passender Prozess gefunden</p>
  <p class="desc">Die angegebene GW-Adresse (next hop) ist nicht local erreichbar</p>
`,maskNoMatch=`
  <p class="msg">Network mask does not match route address</p>
  <p class="expl">Netzmaske passt nicht zur Routenadresse</p>
  <p class="desc">Das angegebene Zielpräfix ist nicht normiert</p>
`,doubleRoute=`
  <p class="msg">Die Datei existiert bereits</p>
  <p class="expl">File exists</p>
  <p class="desc">Die angegebene Route ist bereits in der FIB vorhanden</p>
`,noLocalNhop=`
  <p class="msg">Nexthop address must not be local</p>
  <p class="expl">Die GW-Adresse darf keine lokale Adresse sein</p>
  <p class="desc">Eine GW-Adresse muss einer Schnittstelle in einem direkt erreichbaren Nachbarrouter gehören</p>
`,Route=class extends Prefix{constructor(a,b,c){try{if(super(a),!a)throw Error('Kein Pr\xE4fix');if(b&&c)throw Error('sdev und snhop definiert');if(!b&&!c)throw Error('sdev und snhop nicht definiert');if(b&&(this.dev=b),c&&(this.nhop=aton(c),!this.nhop))throw Error(`snhop: ${c}?`)}catch(a){throw syslog.error(a),Error('Route constructor')}}is(a){try{if(!(a instanceof Route))throw Error('Keine Route-Objekt!');return this.nhop?super.is(a)&&this.nhop===a.nhop:super.is(a)&&this.dev===a.dev}catch(a){return syslog.error(a),!1}}asStrings(){const a={dev:this.dev,nhop:this.nhop?ntoa(this.nhop):void 0};return Object.assign(super.asStrings(),a)}},flush=(a)=>{a&&'string'==typeof a&&[...fib.children].forEach((b)=>{dom2route.get(b).dev===a&&b.remove()})},getRoute=(a)=>{try{if(!a)throw Error('address fehlt');if('string'==typeof a&&(a=aton(a)),!Number.isSafeInteger(a)||a!==a>>>0)throw Error(`Unzulässige Adresse: ${a}`);let b=null;const c=[...fib.children].sort((c,a)=>dom2route.get(a).len-dom2route.get(c).len).some((c)=>(b=c,dom2route.get(c).includes(a)));return c?b:''}catch(a){return syslog.error(a),null}},buildElement=(a)=>{try{if(!(a instanceof Route))throw Error('Kein Route Objekt!');const b=a.asStrings(),c=`
      <p>
        <span class="ui-state-highlight" title="destination">${b.source}</span>
        <span class="ui-state-highlight" title="range">${b.lower} &ndash; ${b.upper}</span>
      </p>
      <p>
        <span title="gw">${b.nhop||'0.0.0.0'}</span>
        <span title="interface">${b.dev||'??'}</span>
      </p>
    `,d=document.createElement('li');return d.classList.add(b.nhop?'remote':'local'),d.innerHTML=c,d}catch(a){return syslog.error(a),null}},store=()=>{let a=[];try{[...fib.children].forEach((b)=>{const c=dom2route.get(b),d={destination:c.source};c.nhop?d.nhop=ntoa(c.nhop):d.dev=c.dev,a.push(d)}),lstore('fib',a)}catch(a){return void syslog.error(a)}},addLocalRoute=(a,b)=>{try{const c=new Route(a,b);if(c.bits===c.lower||c.bits===c.upper)throw syslog.info(`${ntoa(c.bits)} ist keine zulässige Schnittstellenadresse!`),localert(localORbroadcast),Error('IP-Adresse nicht sinnvoll!');flush(b);const d=buildElement(c);if(!d)throw Error('addLocalRoute caller');fib.appendChild(d),dom2route.set(d,c)}catch(a){return syslog.log(a),-1}return 0},addRemoteRoute=(a,b)=>{try{const c=new Route(a,null,b);if(c.bits!==c.lower)throw syslog.info(`Präfix ${c.source} ist nicht normiert!}`),localert(maskNoMatch),Error('Pr\xE4fix nicht normiert');const d=[...fib.children].some((a)=>c.is(dom2route.get(a)));if(d)throw syslog.info('Die Route existiert bereits!'),localert(doubleRoute),Error('Route existiert bereits');let e=getRoute(c.nhop);if(e=e&&dom2route.get(e),!e||e.nhop)throw syslog.info(`Router Adresse ${ntoa(c.nhop)} ist nicht lokal erreichbar.`),localert(noSuchProcess),Error('nhop nicht lokal erreichbar');if(e.bits===c.nhop)throw syslog.info(`Router Adresse ${ntoa(c.nhop)} ist eine lokale Adresse.`),localert(noLocalNhop),Error('nhop ist lokale Adresse');if(c.nhop===e.lower||c.nhop===e.upper)throw syslog.info(`${ntoa(c.nhop)} ist keine zulässige Partneradresse!`),localert(localORbroadcast),Error('nhop nicht sinnvoll');c.dev=e.dev;const f=buildElement(c);if(!f)throw Error('addRemoteRoute caller');fib.appendChild(f),dom2route.set(f,c)}catch(a){return syslog.log(a),-1}return 0};((a)=>{if(!a)throw Error('Kein #ifconfig');const b=a.querySelector('input[data-type="destination"]'),c=a.querySelector('input[data-type="device"]'),d=a.querySelector('input[readonly]');if(!b||!c||!d)throw Error('#ifconfig unvollst\xE4ndig');const e=()=>{const a=b.value.trim(),d=c.value.trim();if(!a||!d)return void localert('Bitte geben Sie lokalen Adressbereich und Schnittstelle an!');const e=addLocalRoute(a,d);e||store()};d.addEventListener('focus',function(a){a.stopPropagation(),a.preventDefault(),e()}),d.addEventListener('click',function(a){a.stopPropagation(),a.preventDefault()})})(document.querySelector('#ifconfig')),((a)=>{if(!a)throw Error('Kein #ifconfig');const b=a.querySelector('input[data-type="destination"]'),c=a.querySelector('input[data-type="nhop"]'),d=a.querySelector('input[readonly]');if(!b||!c||!d)throw Error('#route unvollst\xE4ndig');const e=()=>{const a=b.value.trim(),d=c.value.trim();if(!a||!d)return void localert('Bitte geben Sie entfernten Adressbereich und Partneradresse an!');const e=addRemoteRoute(a,d);e||store()};d.addEventListener('focus',function(a){a.stopPropagation(),a.preventDefault(),e()}),d.addEventListener('click',function(a){a.stopPropagation(),a.preventDefault()})})(document.querySelector('#route')),((a)=>{if(!a)throw Error('Kein #show');const b=a.querySelector('input[data-type="destination"]'),c=a.querySelector('input[readonly]');if(!b||!c)throw Error('#show unvollst\xE4ndig');const d=()=>{const a=(b.value.trim().split(' ')||[])[0];if(!a)return void localert('Bitte geben Sie die Zieladresse an!');const c=getRoute(a),d=c?dom2route.get(c):null;if(!c)return void localert(networkIsUnreachable);const e=aton(a);[...fib.children].forEach((a)=>{a.classList.remove('matched','longest'),dom2route.get(a).includes(e)&&a.classList.add('matched')}),c.classList.add('longest'),b.value=`${a} ist erreichbar über ${d.dev} [${d.source}]`};c.addEventListener('focus',function(a){a.stopPropagation(),a.preventDefault(),d()}),c.addEventListener('click',function(a){a.stopPropagation(),a.preventDefault()}),b.addEventListener('focus',function(a){a.stopPropagation(),a.preventDefault(),b.value=(b.value.match(/^\s*([0-9.]+)/)||[])[1]||'',[...fib.children].forEach((a)=>{a.classList.remove('matched','longest')})})})(document.querySelector('#show')),fib.addEventListener('delete',function(a){if(a.stopPropagation(),a.preventDefault(),a.detail&&a.detail.closest){const b=a.detail.closest,c=dom2route.get(b);c&&(!c.nhop&&flush(c.dev),b.remove(),store())}}),document.querySelector('body').addEventListener('clear',function(){fib.innerHTML='',lstore('fib',[])});try{const a=lstore('fib')||[],b=a.every((a)=>a.nhop?!addRemoteRoute(a.destination,a.nhop):!addLocalRoute(a.destination,a.dev));if(!b)throw Error('Fehler beim Laden aus localStorage')}catch(a){syslog.error(a)}((a)=>{if(!a)return;const b=new Route('1.1.1.1/26','eth2'),c=new Route('2.0.0.0/8',null,'1.1.1.202'),d=new Route('2.111.2.17/8',null,'1.1.1.202');console.log(b.asStrings()),console.log(c.asStrings()),c.is(d)||syslog.panic(Error('test failed')),console.log(buildElement(b).textContent.replace(/[\s]+/g,' | ')),console.log(buildElement(c).textContent.replace(/[\s]+/g,' | ')),addLocalRoute('1.1.1.1/26','eth2'),addLocalRoute('1.1.1.1/26','eth2'),addLocalRoute('5.1.1.1/26','eth2'),addLocalRoute('5.1.1.1/26','eth3'),addLocalRoute('1.1.1.1/16','eth5'),addLocalRoute('1.1.1.1/26','eth4');let e=getRoute(aton('5.1.1.62'));e||syslog.panic(Error('test failed')),'eth2'!==dom2route.get(e).dev&&syslog.panic(Error('test failed')),e=getRoute(aton('1.1.1.62')),e||syslog.panic(Error('test failed')),'eth4'!==dom2route.get(e).dev&&syslog.panic(Error('test failed')),addRemoteRoute('2.0.0.0/8','5.1.1.33')})(!1,!1);